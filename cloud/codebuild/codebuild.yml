version: 0.2

phases:
  pre_build:
    commands:
      # set branch/master -> ,branch/release -> ,branch/develop -> ,branch/feature/post -> -post
      - export CODEBUILD_WEBHOOK_TRIGGER=`echo $CODEBUILD_WEBHOOK_TRIGGER | sed 's/branch\/master\|branch\/release\|branch\/develop//g; s/branch\/feature\//-/g'`

  build:
    commands:

      # build_push:
      - docker build -t jesusmonda/api:${ENVIRONMENT}-${CODEBUILD_BUILD_NUMBER} src/.
      - docker login -u ${DOCKER_USER} -p ${DOCKER_TOKEN}
      - docker push jesusmonda/api:${ENVIRONMENT}-${CODEBUILD_BUILD_NUMBER}

      # eks_credential:
      - aws configure set aws_access_key_id ${AWS_ACCESS_KEY}
      - aws configure set aws_secret_access_key ${AWS_SECRET_KEY}
      - aws configure set default.region ${AWS_REGION}
      - aws eks update-kubeconfig --region ${AWS_REGION} --name ${AWS_CLUSTER_NAME}

      # create_deployment:
      - apt update && apt install -y moreutils
      - envsubst < cloud/k8s_manifest/deployment.yml | sponge cloud/k8s_manifest/deployment.yml

      # kubectl_apply:
      - kubectl apply -f cloud/k8s_manifest/deployment.yml