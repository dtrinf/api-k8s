version: 0.2

run-as: root

phases:
  install:
    commands:
      - apt update
      - apt install -y moreutils
  build:
    commands:
      - docker build -t jesusmonda/api:${ENVIRONMENT}-${CODEBUILD_BUILD_NUMBER} src/.
      - docker login -u ${DOCKER_USER} -p ${DOCKER_TOKEN}
      - docker push jesusmonda/api:${ENVIRONMENT}-${CODEBUILD_BUILD_NUMBER}
      - aws configure set aws_access_key_id ${AWS_ACCESS_KEY}
      - aws configure set aws_secret_access_key ${AWS_SECRET_KEY}
      - aws configure set default.region ${AWS_REGION}
      - aws eks update-kubeconfig --region ${AWS_REGION} --name ${AWS_CLUSTER_NAME}
      - envsubst < cloud/k8s_manifest/deployment-${ENVIRONMENT}.yml | sponge cloud/k8s_manifest/deployment-${ENVIRONMENT}.yml
      - kubectl apply -f cloud/k8s_manifest/deployment-${ENVIRONMENT}.yml